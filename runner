FROM artifactory.voya.net/docker-virtual/openshift/ubi8/openjdk-8:latest

ARG TARGETPLATFORM
ARG RUNNER_VERSION="2.316.1"
ARG RUNNER_CONTAINER_HOOKS_VERSION="0.3.2"
ARG RUNNER_USER_UID=1001
ARG DOCKER_GROUP_GID=121

# 1. Install corporate certificates
COPY voya_ecc_root.crx voyarootca.cer voya_rsa_root.crx zscalerrootca.cer /etc/pki/ca-trust/source/anchors/
RUN update-ca-trust extract

# 2. Install dependencies
RUN microdnf install -y \
        curl \
        git \
        jq \
        sudo \
        unzip \
        zip \
        dnf \
        libicu \
        krb5-libs \
        lttng-ust \
        zlib \
        openssl-libs \
        libyaml-devel \
    && microdnf clean all

# 3. Install git-lfs
RUN dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm \
    && dnf install -y git-lfs \
    && dnf clean all

# 4. Create runner user and directories
RUN groupadd -g $DOCKER_GROUP_GID docker \
    && useradd -m -u $RUNNER_USER_UID runner \
    && usermod -aG docker runner \
    && mkdir -p /home/runner /runnertmp \
    && chown -R runner:runner /home/runner /runnertmp

# 5. Install GitHub Actions Runner
RUN export ARCH=$(echo ${TARGETPLATFORM} | cut -d '/' -f2) \
    && curl -L https://github.com/actions/runner/releases/download/v${RUNNER_VERSION}/actions-runner-linux-${ARCH}-${RUNNER_VERSION}.tar.gz | tar xz -C /home/runner

# 6. Install container hooks
RUN cd /home/runner \
    && curl -O -L https://github.com/actions/runner-container-hooks/releases/download/v${RUNNER_CONTAINER_HOOKS_VERSION}/actions-runner-hooks-${RUNNER_CONTAINER_HOOKS_VERSION}-noarch.tar.gz \
    && tar xzf actions-runner-hooks-${RUNNER_CONTAINER_HOOKS_VERSION}-noarch.tar.gz \
    && rm actions-runner-hooks-*.tar.gz

# 7. Copy run script and set permissions
COPY run.sh /home/runner/run.sh
RUN chmod +x /home/runner/run.sh

# 8. Switch to runner user
USER runner
WORKDIR /home/runner

# 9. Set entrypoint
ENTRYPOINT ["./run.sh"]
