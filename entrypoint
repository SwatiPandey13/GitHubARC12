#!/bin/bash
set -x
source /usr/bin/logger.sh
log.notice "starting entrypoint.sh"

source /usr/bin/graceful-stop.sh

# Set up signal handler
trap 'graceful_stop' TERM

log.notice "Configuring environment for GitHub Actions Runner"

# Certificate setup
if [ -d "$RUNNER_HOME/trusted-certs" ]; then
    log.notice "Installing additional trusted certificates"
    cp -f $RUNNER_HOME/trusted-certs/* /etc/pki/ca-trust/source/anchors/
    update-ca-trust extract
fi

# Create user entry if missing
if [ -e /etc/arc/hooks/create-passwd ]; then
    log.notice "Creating user entry"
    /etc/arc/hooks/create-passwd
fi

# Configure subuid/subgid for current user
log.notice "Configuring UID/GID mappings"
USER_ID=$(id -u)
GROUP_ID=$(id -g)
USER_NAME=$(id -un)

# Update subuid
if ! grep -q "^${USER_NAME}:" /etc/subuid; then
    log.notice "Creating subuid mapping for ${USER_NAME}"
    echo "${USER_NAME}:${USER_ID}:1" >> /etc/subuid
    echo "${USER_NAME}:100000:65536" >> /etc/subuid
fi

# Update subgid
if ! grep -q "^${USER_NAME}:" /etc/subgid; then
    log.notice "Creating subgid mapping for ${USER_NAME}"
    echo "${USER_NAME}:${GROUP_ID}:1" >> /etc/subgid
    echo "${USER_NAME}:100000:65536" >> /etc/subgid
fi

# Configure Podman storage
log.notice "Initializing Podman storage"
export CONTAINERS_CONF=/etc/containers/containers.conf
mkdir -p ${HOME}/.local/share/containers

# Run storage initialization with debug logging
log.notice "Running podman system migrate"
podman system migrate --log-level=debug

# Verify storage configuration
log.notice "Podman storage configuration:"
podman info --format=json | jq .store

log.notice "Starting GitHub Actions Runner"

# Start the runner in background
/usr/bin/startup.sh &
RUNNER_PID=$!

# Wait for runner to exit
wait $RUNNER_PID
RUNNER_EXIT_CODE=$?

log.notice "Runner process exited with code ${RUNNER_EXIT_CODE}"

# Clean up .runner file if exists
if [ -f "${HOME}/.runner" ]; then
  log.notice "Removing .runner file"
  rm -f "${HOME}/.runner"
fi

log.notice "Exiting container"
exit $RUNNER_EXIT_CODE
