# [...] (keep all previous sections until OpenShift permissions)

# OpenShift permissions (run as root)
RUN chown -R 1001:0 /home/runner /usr/lib/jvm /opt/maven && \
    chmod -R g+rw /home/runner /usr/lib/jvm /opt/maven

# ▼▼▼ ADD THE NEW ENTRYPOINT CODE HERE ▼▼▼
# Create self-healing entrypoint (must be done as root)
USER root
RUN echo -e '#!/bin/sh\n\
if [ "$1" = "shell" ]; then\n\
    exec /bin/bash\n\
elif [ "$1" = "java" ] || [ "$1" = "javac" ] || [ "$1" = "mvn" ]; then\n\
    exec "$@"\n\
else\n\
    cd /home/runner\n\
    while :; do\n\
        echo "Starting GitHub Actions Runner..."\n\
        ./run.sh "$@" || {\n\
            echo "Runner exited with code $?. Restarting in 5s..." >&2\n\
            sleep 5\n\
        }\n\
    done\n\
fi' > /entrypoint.sh && \
chmod +x /entrypoint.sh && \
chown 1001:0 /entrypoint.sh

# Switch to runner user (must be the last USER command)
USER 1001
# ▲▲▲ END OF NEW CODE ▲▲▲

WORKDIR /home/runner
ENTRYPOINT ["/entrypoint.sh"]
CMD ["run"]
