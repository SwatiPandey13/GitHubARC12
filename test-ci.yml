# [...] (keep all previous sections until Maven installation)

# Install Maven 3.8.8 with certificate verification
RUN wget --no-check-certificate \
    https://archive.apache.org/dist/maven/maven-3/3.8.8/binaries/apache-maven-3.8.8-bin.tar.gz \
    -O /tmp/maven.tar.gz && \
    tar -xzf /tmp/maven.tar.gz -C /opt && \
    ln -s /opt/apache-maven-3.8.8 /opt/maven && \
    rm /tmp/maven.tar.gz

# ▼▼▼ CRITICAL FIXES ▼▼▼
# Remove conflicting Maven installations
RUN rm -rf /usr/share/maven /usr/local/apache-maven && \
    # Ensure Maven bin is in PATH
    ln -s /opt/maven/bin/mvn /usr/local/bin/mvn && \
    # Create conf directory with correct permissions
    mkdir -p /opt/maven/conf && \
    chown -R 1001:0 /opt/maven && \
    chmod -R g+rw /opt/maven

# Copy settings.xml
COPY settings.xml /opt/maven/conf/settings.xml
RUN chmod 644 /opt/maven/conf/settings.xml && \
    # Setup user-level config
    mkdir -p /home/runner/.m2 && \
    chown -R 1001:0 /home/runner/.m2 && \
    chmod -R g+rw /home/runner/.m2 && \
    ln -sf /opt/maven/conf/settings.xml /home/runner/.m2/settings.xml
# ▲▲▲ END FIXES ▲▲▲

# Environment configuration
ENV JAVA_HOME=/usr/lib/jvm/jdk8 \
    JAVA_HOME_8=/usr/lib/jvm/jdk8 \
    JAVA_HOME_11=/usr/lib/jvm/jdk11 \
    MAVEN_HOME=/opt/maven \
    MAVEN_CONFIG=/opt/maven/conf \
    PATH="${JAVA_HOME}/bin:${MAVEN_HOME}/bin:/usr/local/bin:${PATH}:/home/runner" \
    # [...] (rest of your existing ENV vars)
