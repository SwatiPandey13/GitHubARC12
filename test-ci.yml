# Stage 1: UBI with JDK
FROM artifactory.voya.net/docker-virtual/openshift/ubi8/openjdk-8:latest AS jdk

# Corporate certificates
COPY voya_ecc_root.crx /etc/pki/ca-trust/source/anchors/
COPY voyarootca.cer /etc/pki/ca-trust/source/anchors/
COPY voya_rsa_root.crx /etc/pki/ca-trust/source/anchors/
COPY zscalerrootca.cer /etc/pki/ca-trust/source/anchors/
RUN update-ca-trust extract


# Core packages with cleanup
#RUN microdnf install -y \
#    ca-certificates \
#    java-17-openjdk-devel \
#    wget \
 #   tar \
  #  && microdnf clean all

# Install JDK 17
RUN microdnf install -y java-17-openjdk-devel && microdnf clean all

# Stage 2: GitHub Runner
FROM artifactory.voya.net/docker-virtual/openshift/actions/actions-runner:latest

# Java installation
COPY --from=artifactory.voya.net/docker-virtual/rhel8-openjdk8-11-devil:latest \
    /usr/lib/jvm/java-1.8.0-openjdk /usr/lib/jvm/jdk8
COPY --from=artifactory.voya.net/docker-virtual/rhel8-openjdk8-11-devil:latest \
    /usr/lib/jvm/java-11-openjdk /usr/lib/jvm/jdk11


USER root

# Set Java environment variables
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk
ENV PATH="${JAVA_HOME}/bin:${PATH}"

# Install Maven 3.8.8 with checksum verification
#ENV MAVEN_VERSION=3.8.8 \
#    MAVEN_SHA=2e181515ce9ae19f4f4ab9bde9822a2a1a0c1d6d4b8b3b8629b858c4d4c7f8d


# Maven installation using curl (no package manager needed)
RUN curl -k -L -o /tmp/maven.tar.gz \
        https://archive.apache.org/dist/maven/maven-3/3.8.8/binaries/apache-maven-3.8.8-bin.tar.gz \
    && tar -xzf /tmp/maven.tar.gz -C /opt \
    && ln -s /opt/apache-maven-3.8.8 /opt/maven \
    && ln -s /opt/maven/bin/mvn /usr/local/bin/mvn \
    && rm /tmp/maven.tar.gz


# Set Maven environment variables
ENV MAVEN_HOME=/opt/maven \
    MAVEN_CONFIG=/home/runner/.m2 \
    PATH="${MAVEN_HOME}/bin:${PATH}"

# Create Maven directory and configure permissions
RUN mkdir -p /home/runner/.m2 && \
    chown -R 1001:123 /home/runner/.m2 && \
    chmod -R g+rw /home/runner/.m2

# OpenShift permissions
RUN chgrp -R 0 /home/runner /opt/maven /opt/apache-maven-3.8.8 && \
    chmod -R g=u /home/runner /opt/maven /opt/apache-maven-3.8.8

USER 1001
